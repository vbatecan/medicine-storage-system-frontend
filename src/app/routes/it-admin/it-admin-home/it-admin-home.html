<div class="it-admin-container">
  <!-- Navigation -->
  <app-it-admin-navigation></app-it-admin-navigation>

  <div class="header">
    <h1>IT Admin Dashboard</h1>
    <p>Manage user registrations and view registered users</p>
  </div>

  <!-- Action Buttons -->
  <div class="action-bar">
    <button
      class="btn btn-primary"
      (click)="toggleRegistrationForm()"
      [disabled]="loading()">
      {{ showRegistrationForm() ? 'Cancel Registration' : 'Register New User' }}
    </button>
    <button
      class="btn btn-secondary"
      (click)="loadUsers()"
      [disabled]="loading()">
      Refresh Users
    </button>
  </div>

  <!-- Messages -->
  @if (error() || success()) {
    <div class="messages">
      @if (error()) {
        <div class="alert alert-error">
          {{ error() }}
        </div>
      }
      @if (success()) {
        <div class="alert alert-success">
          {{ success() }}
        </div>
      }
    </div>
  }

  @if (showRegistrationForm()) {
    <div class="registration-form">
      <div class="form-card">
        <h2>Register New User</h2>
        <form [formGroup]="userForm" (ngSubmit)="registerUser()">

          <div class="form-group">
            <label for="faceName">Face Name *</label>
            <input
              type="text"
              id="faceName"
              formControlName="face_name"
              placeholder="Enter unique face identifier"
              class="form-control"
              [class.error]="faceNameControl?.invalid && faceNameControl?.touched">
            <small class="form-hint">This will be used for face recognition authentication</small>
            @if (faceNameControl?.invalid && faceNameControl?.touched) {
              <div class="validation-error">
                @if (faceNameControl?.errors?.['required']) {
                  <small>Face name is required</small>
                }
                @if (faceNameControl?.errors?.['minlength']) {
                  <small>Face name must be at least 2 characters</small>
                }
              </div>
            }
          </div>

          <!-- Email -->
          <div class="form-group">
            <label for="email">Email *</label>
            <input
              type="email"
              id="email"
              formControlName="email"
              placeholder="user@example.com"
              class="form-control"
              [class.error]="emailControl?.invalid && emailControl?.touched">
            @if (emailControl?.invalid && emailControl?.touched) {
              <div class="validation-error">
                @if (emailControl?.errors?.['required']) {
                  <small>Email is required</small>
                }
                @if (emailControl?.errors?.['email']) {
                  <small>Please enter a valid email address</small>
                }
              </div>
            }
          </div>

          <div class="form-group">
            <label for="password">Password *</label>
            <input
              type="password"
              id="password"
              formControlName="password"
              placeholder="Enter secure password"
              class="form-control"
              [class.error]="passwordControl?.invalid && passwordControl?.touched">
            @if (passwordControl?.invalid && passwordControl?.touched) {
              <div class="validation-error">
                @if (passwordControl?.errors?.['required']) {
                  <small>Password is required</small>
                }
                @if (passwordControl?.errors?.['minlength']) {
                  <small>Password must be at least 6 characters</small>
                }
              </div>
            }
          </div>

          <!-- Role -->
          <div class="form-group">
            <label for="role">Role *</label>
            <select
              id="role"
              formControlName="role"
              class="form-control">
              @for (role of roles; track role) {
                <option [value]="role">
                  {{ role.replace('_', ' ') }}
                </option>
              }
            </select>
          </div>

          <!-- Active Status -->
          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                formControlName="is_active">
              <span class="checkmark"></span>
              User is Active
            </label>
          </div>

          <!-- Selfie Upload -->
          <div class="form-group">
            <label for="selfieInput">Selfie Image *</label>
            <input
              type="file"
              id="selfieInput"
              (change)="onFileSelected($event)"
              accept="image/*"
              class="file-input">
            @if (selectedFile()) {
              <div class="file-info">
                <span class="file-name">{{ selectedFile()!.name }}</span>
                <span class="file-size">({{ (selectedFile()!.size / 1024).toFixed(1) }} KB)</span>
              </div>
            }
            <small class="form-hint">Please upload a clear front-facing photo for face recognition</small>
            @if (!selectedFile() && userForm.dirty) {
              <div class="validation-error">
                <small>Selfie image is required</small>
              </div>
            }
          </div>

          <div class="form-actions">
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="loading() || userForm.invalid">
              @if (loading()) {
                <span class="spinner"></span>
              }
              {{ loading() ? 'Registering...' : 'Register User' }}
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              (click)="resetForm()"
              [disabled]="loading()">
              Reset Form
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Users List -->
  <div class="users-section">
    <h2>Registered Users</h2>

    @if (loading() && !showRegistrationForm()) {
      <div class="loading">
        <div class="spinner"></div>
        <span>Loading users...</span>
      </div>
    }

    @if (!loading() && hasUsers()) {
      <div class="users-grid">
        @for (user of users(); track trackByUserId($index, user)) {
          <div class="user-card">
            <div class="user-header">
              <div class="user-info">
                <h3>{{ user.face_name }}</h3>
                <p class="user-email">{{ user.email }}</p>
              </div>
              <div class="user-badges">
                <span class="badge" [ngClass]="getStatusBadgeClass(user.is_active)">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
                <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                  {{ user.role.replace('_', ' ') }}
                </span>
              </div>
            </div>

            @if (user.created_at) {
              <div class="user-meta">
                <small>Registered: {{ user.created_at | date:'medium' }}</small>
              </div>
            }

            <!-- User Actions -->
            <div class="user-actions">
              <button
                type="button"
                class="btn btn-toggle"
                [class.btn-activate]="!user.is_active"
                [class.btn-deactivate]="user.is_active"
                [disabled]="isUserBeingProcessed(user)"
                (click)="toggleUserStatus(user)"
                [title]="user.is_active ? 'Deactivate user' : 'Activate user'">
                @if (isUserBeingProcessed(user)) {
                  <span class="spinner"></span>
                } @else {
                  @if (user.is_active) {
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364l12.728-12.728"/>
                    </svg>
                  } @else {
                    <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  }
                }
                {{ user.is_active ? 'Deactivate' : 'Activate' }}
              </button>

              <button
                type="button"
                class="btn btn-danger"
                [disabled]="isUserBeingProcessed(user)"
                (click)="deleteUser(user)"
                title="Delete user permanently">
                @if (isUserBeingProcessed(user)) {
                  <span class="spinner"></span>
                } @else {
                  <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                }
                Delete
              </button>
            </div>
          </div>
        }
      </div>
    }

    @if (!loading() && !hasUsers()) {
      <div class="empty-state">
        <div class="empty-icon">ðŸ‘¥</div>
        <h3>No Users Found</h3>
        <p>No users have been registered yet. Click "Register New User" to add the first user.</p>
      </div>
    }
  </div>
</div>
